function sys = process_gudi(t,x,flag,u,p)

switch flag,
    case 0 % f(x,u,p,t)
a = 6.9;
k = 0.02;
km = 95.6;
ks = 6.65;
ki = 104.5;
alpha = 9.2;
muem = 0.25;
b = 0.023;
n = 0.4;
kg = 33.0;
kl = 0.0037;
vmo = 68;
beta = 0.073;
sf = 50;
gf = 200;

mue = muem*exp(-kl*x(4))*(x(3)/(ks+x(3)+x(3)*x(3)/ki));
rg = vmo*exp(-k*x(4)^n)*(x(2)/(km*(1+x(3)/kg)+x(2)));
        
x_dot1= -(u(1)+u(2)/x(5))*x(1) + mue*x(1);
x_dot2= u(2)*sf/x(5) -((u(1)+u(2))/x(5))*x(2) - rg/1.11;
x_dot3= u(1)*gf/x(5) -((u(1)+u(2))/x(5))*x(3) + (rg-(a*mue*x(1)+b*x(1)));
x_dot4= -((u(1)+u(2))/x(5))*x(4) + (alpha*mue*x(1)+beta*x(1));
x_dot5= u(1)+u(2);

        
 sys = [x_dot1;x_dot2;x_dot3;x_dot4;x_dot5];
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
    case 1 % df/dx
 a = 6.9;
k = 0.02;
km = 95.6;
ks = 6.65;
ki = 104.5;
alpha = 9.2;
muem = 0.25;
b = 0.023;
n = 0.4;
kg = 33.0;
kl = 0.0037;
vmo = 68;
beta = 0.073;
sf = 50;
gf = 200;

mue = muem*exp(-kl*x(4))*(x(3)/(ks+x(3)+x(3)^2/ki));
rg = vmo*exp(-k*x(4)^n)*(x(2)/(km*(1+x(3)/kg)+x(2)));

f1x1 = x(3)/(4*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)) - u(2)/x(5) - u(1);
f2x1 = 0;
f3x1 = - (69*x(3))/(40*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)) - 23/1000;
f4x1 = (23*x(3))/(10*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)) + 73/1000;
f5x1 = 0;


f1x2 = 0;
f2x2 = (6800*x(2))/(111*exp(x(4)^(2/5)/50)*(x(2) + (478*x(3))/165 + 478/5)^2) - (u(1) + u(2))/x(5) - 6800/(111*exp(x(4)^(2/5)/50)*(x(2) + (478*x(3))/165 + 478/5));
f3x2 = 68/(exp(x(4)^(2/5)/50)*(x(2) + (478*x(3))/165 + 478/5)) - (68*x(2))/(exp(x(4)^(2/5)/50)*(x(2) + (478*x(3))/165 + 478/5)^2);
f4x2 = 0;
f5x2 = 0;

f1x3 = x(1)/(4*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)) - (x(1)*x(3)*((4*x(3))/209 + 1))/(4*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)^2);
f2x3 = (650080*x(2))/(3663*exp(x(4)^(2/5)/50)*(x(2) + (478*x(3))/165 + 478/5)^2);
f3x3 = (69*x(1)*x(3)*((4*x(3))/209 + 1))/(40*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)^2) - (32504*x(2))/(165*exp(x(4)^(2/5)/50)*(x(2) + (478*x(3))/165 + 478/5)^2) - (69*x(1))/(40*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)) - (u(1) + u(2))/x(5);
f4x3 = (23*x(1))/(10*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)) - (23*x(1)*x(3)*((4*x(3))/209 + 1))/(10*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)^2);
f5x3 = 0;

f1x4 = -(37*x(1)*x(3))/(40000*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20));
f2x4 = (272*x(2))/(555*x(4)^(3/5)*exp(x(4)^(2/5)/50)*(x(2) + (478*x(3))/165 + 478/5));
f3x4 = (2553*x(1)*x(3))/(400000*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20)) - (68*x(2))/(125*x(4)^(3/5)*exp(x(4)^(2/5)/50)*(x(2) + (478*x(3))/165 + 478/5));
f4x4 = - (u(1) + u(2))/x(5) - (851*x(1)*x(3))/(100000*exp((37*x(4))/10000)*((2*x(3)^2)/209 + x(3) + 133/20));
f5x4 = 0;

f1x5 = (u(2)*x(1))/x(5)^2;
f2x5 = (x(2)*(u(1) + u(2)))/x(5)^2 - (200*u(2))/x(5)^2;
f3x5 = (x(3)*(u(1) + u(2)))/x(5)^2 - (30*u(1))/x(5)^2;
f4x5 = (x(4)*(u(1) + u(2)))/x(5)^2;
f5x5 = 0;

sys = [f1x1 f2x1 f3x1 f4x1 f5x1;
       f1x2 f2x2 f3x2 f4x2 f5x2;
       f1x3 f2x3 f3x3 f4x3 f5x3;
       f1x4 f2x4 f3x4 f4x4 f5x4;
       f1x5 f2x5 f3x5 f4x5 f5x5];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
    case 2 % df/du
 a = 6.9;
k = 0.02;
km = 95.6;
ks = 6.65;
ki = 104.5;
alpha = 9.2;
muem = 0.25;
b = 0.023;
n = 0.4;
kg = 33.0;
kl = 0.0037;
vmo = 68;
beta = 0.073;
sf = 50;
gf = 200;

mue = muem*exp(-kl*x(4))*(x(3)/(ks+x(3)+x(3)^2/ki));
rg = vmo*exp(-k*x(4)^n)*(x(2)/(km*(1+x(3)/kg)+x(2)));

f1u1 = -x(1);
f2u1 = -x(2)/x(5);
f3u1 = 30/x(5) - x(3)/x(5);
f4u1 = -x(4)/x(5);
f5u1 = 1;

f1u2 = -x(1)/x(5);
f2u2 = 200/x(5) - x(2)/x(5);
f3u2 =  -x(3)/x(5);
f4u2 = -x(4)/x(5);
f5u2 = 1;

sys = [f1u1 f2u1 f3u1 f4u1 f5u1;
        f1u2 f2u2 f3u2 f4u2 f5u2];   


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
        
    case 3 % df/dp
        sys = [];
    case 4 % df/dt
        sys = [];
    case 5 % x0
        sys = [0.5;30;7.5;0;9];
    case 6 % dx0/dp
        sys = [];
    case 7 % M
        sys = [];
    case 8 % unused flag
        sys = [];
    otherwise
        error(['unhandled flag = ',num2str(flag)]); 
end